<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ethan.crmsystem.mapper.CustomerMapper">

    <resultMap id="RM_CUSTOMER" type="com.ethan.crmsystem.mapper.bean.CustomerBean">
        <result column="code" jdbcType="VARCHAR" property="code"></result>
        <result column="name" jdbcType="VARCHAR" property="name"></result>
        <result column="phonenum" jdbcType="VARCHAR" property="phonenum"></result>
        <result column="address" jdbcType="VARCHAR" property="address"></result>
        <result column="region_id" jdbcType="VARCHAR" property="region_id"></result>
        <result column="update_time" jdbcType="VARCHAR" property="update_time"></result>
        <result column="user_id" jdbcType="VARCHAR" property="user_id"></result>
        <result column="creat_time" jdbcType="VARCHAR" property="creat_time"></result>
    </resultMap>
    
    <sql id="CUSTOMER-CONDITION">
        <where>
            rp.role_id = #{roleId}
            <if test="customerForm.code != '' and customerForm.code != null">
                and c.code like concat('%',#{customerForm.code},'%')
            </if>
            <if test="customerForm.name != '' and customerForm.name != null">
                and c.name like concat('%',#{customerForm.name},'%')
            </if>
            <if test="customerForm.phonenum != '' and customerForm.phonenum != null">
                and c.phonenum like concat('%', #{customerForm.phonenum},'%')
            </if>
            <if test="customerForm.address != '' and customerForm.address != null">
                and c.address like concat('%', #{customerForm.address},'%')
            </if>
            <if test="customerForm.level != '' and customerForm.regionIds != null and customerForm.regionIds.size()>0" >
                and c.region_id in
                <foreach collection="customerForm.regionIds" item="item" open="(" close=")" separator="," >
                    #{item}
                </foreach>
            </if>
            <if test="customerForm.startTime != null and customerForm.endTime != null">
                and c.creat_time between #{customerForm.startTime} and #{customerForm.endTime}
            </if>
        </where>
    </sql>

    <select id="findCustomerInfoByCondition" resultType="com.ethan.crmsystem.mapper.bean.CustomerBean">
        select c.* from
        customer c left join role_priviledge rp on c.region_id = rp.meta_region_id
        <include refid="CUSTOMER-CONDITION"/>
        limit #{customerForm.offset},#{customerForm.pageSize}
    </select>

    <select id="findCountByCondition" resultType="string">
        select count(1) from
        customer c left join role_priviledge rp on c.region_id = rp.meta_region_id
        <include refid="CUSTOMER-CONDITION"/>
    </select>

</mapper>